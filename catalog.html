<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>StockTone — Catalog</title>
  <link rel="stylesheet" href="style.css">
  <script src="config.js"></script>
</head>
<body>
  <main class="container">
    <header class="site-header">
      <h1>Catalog</h1>
      <p class="muted">รายการสินค้าทั้งหมด</p>
    </header>

    <section class="card">
      <div class="search-row">
        <input id="q" placeholder="ค้นหาสินค้า..." />
        <button id="btnSearch">ค้นหา</button>
      </div>

      <div id="listMsg" class="muted small">ยังไม่โหลด</div>
      <table id="catalogTable" class="table">
        <thead>
          <tr><th>รูป</th><th>SKU</th><th>ชื่อ</th><th>จำนวน</th><th>ต้นทุน</th><th>สถานะ</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <footer class="site-footer">
      <a href="index.html">← กลับหน้าแรก</a>
    </footer>
  </main>

  <script>
    // ใช้ APPS_SCRIPT_URL จาก config.js
    async function apiGet(params){
      const url = APPS_SCRIPT_URL + '?' + new URLSearchParams(params).toString();
      const res = await fetch(url);
      return res.json();
    }

    async function loadCatalog(q){
      document.getElementById('listMsg').textContent = 'กำลังโหลด...';
      try{
        const params = { action:'list', limit:200 };
        if(q) params.q = q;
        const r = await apiGet(params);
        if(!r.ok) { document.getElementById('listMsg').textContent = 'โหลดล้มเหลว: '+(r.error||''); return; }
        const tbody = document.querySelector('#catalogTable tbody');
        tbody.innerHTML = '';
        (r.data||[]).forEach(p=>{
          const tr = document.createElement('tr');
          const img = document.createElement('img'); img.src = p.imageUrl || ''; img.style.width='64px'; img.style.height='64px'; img.style.objectFit='cover';
          const imgTd = document.createElement('td'); imgTd.appendChild(img);
          tr.appendChild(imgTd);
          tr.innerHTML += '<td>'+ (p.sku||'') +'</td>';
          tr.innerHTML += '<td><a href="product.html?sku='+encodeURIComponent(p.sku)+'">'+ (p.name||'') +'</a></td>';
          tr.innerHTML += '<td>'+ (p.quantity||0) +'</td>';
          tr.innerHTML += '<td>'+ (p.cost||'') +'</td>';
          tr.innerHTML += '<td>'+ (p.status||'') +'</td>';
          tbody.appendChild(tr);
        });
        document.getElementById('listMsg').textContent = 'โหลดสำเร็จ (' + (r.total||0) + ')';
      }catch(err){
        console.error(err);
        document.getElementById('listMsg').textContent = 'ข้อผิดพลาด: '+err.message;
      }
    }

    document.getElementById('btnSearch').addEventListener('click', ()=> loadCatalog(document.getElementById('q').value));
    document.getElementById('q').addEventListener('keydown', (e)=> { if(e.key==='Enter') loadCatalog(e.target.value); });

    // initial load
    loadCatalog();
  </script>
</body>
</html>

